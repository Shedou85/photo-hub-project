---
phase: 04-review-and-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/CollectionDetailsPage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: false

must_haves:
  truths:
    - "Photographer opens a collection in SELECTING or REVIEWING status and sees filter tabs: All / Selected / Not Selected"
    - "Filter tabs show accurate counts (e.g. All (20), Selected (8), Not Selected (12))"
    - "Clicking a filter tab filters the photo grid to only matching photos"
    - "Selected photos display a blue checkmark badge on their thumbnail in the grid"
    - "Filter resets to All when navigating to a different collection"
  artifacts:
    - path: "frontend/src/pages/CollectionDetailsPage.jsx"
      provides: "Selections fetch, filter tabs UI, selection badge rendering"
      contains: "selectedPhotoIds"
    - path: "frontend/src/locales/en.json"
      provides: "Filter tab labels in English"
      contains: "filterAll"
    - path: "frontend/src/locales/lt.json"
      provides: "Filter tab labels in Lithuanian"
      contains: "filterAll"
    - path: "frontend/src/locales/ru.json"
      provides: "Filter tab labels in Russian"
      contains: "filterAll"
  key_links:
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "/collections/{id}/selections"
      via: "fetch with credentials in useEffect"
      pattern: "collections.*selections"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "photo grid rendering"
      via: "filteredPhotos derived from filter + selectedPhotoIds"
      pattern: "filteredPhotos"
---

<objective>
Add photographer selection review UI to CollectionDetailsPage with filter tabs (All/Selected/Not Selected) and selection badges on photo thumbnails.

Purpose: Enables REVIEW-01 (photographer sees which photos client selected) and REVIEW-02 (filter by selection status). This is the core review workflow that the photographer uses to decide which photos to edit.

Output: CollectionDetailsPage.jsx with selections fetch, filter tabs above photo grid, blue checkmark badges on selected thumbnails, and i18n keys in all 3 locales.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-and-delivery/04-RESEARCH.md

Key existing code:
- frontend/src/pages/CollectionDetailsPage.jsx — Main file to extend (637 lines). Already has: photo grid, lightbox, upload zone, status transitions, cover management.
- backend/collections/selections.php — GET /collections/{id}/selections returns { status: "OK", selections: [{ id, photoId, createdAt }] } (authenticated, ownership-verified).
- frontend/src/locales/en.json — Current i18n keys in `collection` namespace.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selections fetch, filter tabs, and selection badges to CollectionDetailsPage</name>
  <files>
    frontend/src/pages/CollectionDetailsPage.jsx
    frontend/src/locales/en.json
    frontend/src/locales/lt.json
    frontend/src/locales/ru.json
  </files>
  <action>
Extend CollectionDetailsPage.jsx with three additions:

**1. Fetch selections on mount:**
- Add `const [selections, setSelections] = useState([]);` state
- Add `const [filter, setFilter] = useState('all');` state ('all' | 'selected' | 'not-selected')
- Add useEffect to fetch selections from `GET /collections/${id}/selections` with `credentials: 'include'`. On success, set selections. Non-critical failure — catch silently.
- Add `useEffect(() => { setFilter('all'); }, [id]);` to reset filter when collection changes (Pitfall 5 from research).
- Build `selectedPhotoIds` as a `useMemo(() => new Set(selections.map(s => s.photoId)), [selections])`.
- Build `filteredPhotos` as a `useMemo` that returns:
  - `filter === 'all'` → `photos`
  - `filter === 'selected'` → `photos.filter(p => selectedPhotoIds.has(p.id))`
  - `filter === 'not-selected'` → `photos.filter(p => !selectedPhotoIds.has(p.id))`

**2. Render filter tabs above the photo grid:**
Place inside the Photo Grid Card (`bg-white border border-gray-200 rounded-[10px]`), ABOVE the existing `grid` div but BELOW the section heading.

Three tab buttons in a `flex gap-2 mb-4 border-b border-gray-200` container:
- "All (N)" — `t('collection.filterAll')` with `({photos.length})` count
- "Selected (N)" — `t('collection.filterSelected')` with `({selectedPhotoIds.size})` count
- "Not Selected (N)" — `t('collection.filterNotSelected')` with `({photos.length - selectedPhotoIds.size})` count

Active tab styling: `text-blue-600 border-b-2 border-blue-600`
Inactive tab styling: `text-gray-500 hover:text-gray-700`
All tabs: `px-4 py-2 text-sm font-semibold transition-colors bg-transparent border-0 cursor-pointer`

Only show filter tabs when `selections.length > 0` (no tabs for collections with zero selections — DRAFT collections before any client interaction).

**3. Render selection badge on photo thumbnails:**
Inside the photo grid `.map()`, after the existing cover badge conditional, add:
```jsx
{selectedPhotoIds.has(photo.id) && (
  <div className="absolute top-2 right-2 w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center shadow-md">
    <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
    </svg>
  </div>
)}
```

**4. Update the photo grid to use `filteredPhotos` instead of `photos`:**
Change `{photos.map((photo, index) => (` to `{filteredPhotos.map((photo, index) => (` in the grid rendering.

IMPORTANT: The lightbox navigation must still use the full `photos` array for prev/next. When opening the lightbox from filtered view, find the photo's index in the full `photos` array: `setLightboxIndex(photos.findIndex(p => p.id === photo.id))`.

**5. Add i18n keys to all 3 locale files:**

In `collection` namespace of en.json:
```json
"filterAll": "All",
"filterSelected": "Selected",
"filterNotSelected": "Not selected"
```

In lt.json (Lithuanian):
```json
"filterAll": "Visos",
"filterSelected": "Pasirinktos",
"filterNotSelected": "Nepasirinktos"
```

In ru.json (Russian):
```json
"filterAll": "Все",
"filterSelected": "Выбранные",
"filterNotSelected": "Невыбранные"
```

Place these keys after `statusUpdateError` in the `collection` namespace, before the closing brace.
  </action>
  <verify>
1. Run `cd frontend && npm run lint` — zero warnings
2. Run `cd frontend && npm run build` — successful build
3. Grep for `filterAll` in all 3 locale files — present in en.json, lt.json, ru.json
4. Grep for `selectedPhotoIds` in CollectionDetailsPage.jsx — present
5. Grep for `filteredPhotos` in CollectionDetailsPage.jsx — present
  </verify>
  <done>
- CollectionDetailsPage fetches selections on mount and builds a Set of selected photo IDs
- Filter tabs (All/Selected/Not Selected) appear above the photo grid when selections exist, with accurate counts
- Clicking a filter tab filters the grid to matching photos
- Selected photos show a blue checkmark badge on their thumbnail
- Lightbox navigation uses full photo array regardless of active filter
- Filter resets to 'all' on collection change
- All i18n keys present in EN, LT, RU
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify filter tabs and selection badges</name>
  <what-built>
Selection review UI on CollectionDetailsPage: filter tabs (All/Selected/Not Selected) with counts, blue checkmark badges on selected photo thumbnails, and filter reset on collection change.
  </what-built>
  <how-to-verify>
1. Open a collection that has client selections (status SELECTING or REVIEWING) at /collection/{id}
2. Verify filter tabs appear above the photo grid with correct counts
3. Click "Selected" tab — only selected photos should show (with blue checkmarks)
4. Click "Not Selected" tab — only unselected photos should show (no blue checkmarks)
5. Click "All" tab — all photos should show (selected ones have blue checkmarks)
6. Click a photo to open lightbox — prev/next should navigate through ALL photos, not just filtered set
7. Navigate to a different collection — filter should reset to "All"
8. Open a DRAFT collection with no selections — no filter tabs should appear
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. Filter tabs render with correct counts matching selections data
4. Photo grid filters correctly per active tab
5. Selection badges visible on selected photo thumbnails
6. Lightbox navigation uses full photos array
7. Filter state resets on collection ID change
</verification>

<success_criteria>
- Photographer can see which photos the client selected (REVIEW-01)
- Photographer can filter photos by All / Selected / Not Selected (REVIEW-02)
- Selection indicators are visible on photo thumbnails without hover
- Filter tabs show accurate counts
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-and-delivery/04-01-SUMMARY.md`
</output>
