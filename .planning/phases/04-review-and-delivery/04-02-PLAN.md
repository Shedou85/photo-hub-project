---
phase: 04-review-and-delivery
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - frontend/src/pages/CollectionDetailsPage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: false

must_haves:
  truths:
    - "Photographer sees an edited finals upload zone when collection status is REVIEWING"
    - "Photographer can upload edited photos via the green upload zone and they appear in a grid below it"
    - "Photographer sees a 'Mark as Delivered' button when collection is in REVIEWING status"
    - "'Mark as Delivered' button is disabled until at least one edited photo is uploaded"
    - "Clicking 'Mark as Delivered' transitions the collection status to DELIVERED"
    - "Collection card turns green border in REVIEWING status (already working from Phase 2)"
  artifacts:
    - path: "frontend/src/pages/CollectionDetailsPage.jsx"
      provides: "Edited finals upload zone, edited photos grid, DELIVERED transition button"
      contains: "editedPhotos"
    - path: "frontend/src/locales/en.json"
      provides: "Edited upload labels and delivery button text in English"
      contains: "editedFinalsTitle"
    - path: "frontend/src/locales/lt.json"
      provides: "Edited upload labels and delivery button text in Lithuanian"
      contains: "editedFinalsTitle"
    - path: "frontend/src/locales/ru.json"
      provides: "Edited upload labels and delivery button text in Russian"
      contains: "editedFinalsTitle"
  key_links:
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "/collections/{id}/edited"
      via: "fetch GET for listing, fetch POST for uploads"
      pattern: "collections.*edited"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "/collections/{id} PATCH"
      via: "handleMarkAsDelivered status transition"
      pattern: "DELIVERED"
---

<objective>
Add edited finals upload zone and DELIVERED status transition to CollectionDetailsPage for the photographer delivery workflow.

Purpose: Enables DELIV-01 (photographer uploads edited finals) and completes the collection lifecycle by transitioning to DELIVERED status. Also satisfies REVIEW-03 (collection card turns green in REVIEWING — already done in Phase 2, verified here).

Output: CollectionDetailsPage.jsx with edited photos upload zone (green-themed, REVIEWING-only), edited photos grid, "Mark as Delivered" button, and i18n keys in all 3 locales.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-review-and-delivery/04-RESEARCH.md
@.planning/phases/04-review-and-delivery/04-01-SUMMARY.md

Key existing code:
- frontend/src/pages/CollectionDetailsPage.jsx — Extended in 04-01 with selections and filter tabs. Now adding edited upload zone and delivery button.
- backend/collections/edited.php — Already functional: GET returns edited photos list, POST uploads new edited photo (uses handleFileUpload with 'edited' subdirectory), DELETE removes edited photo. Authenticated + ownership verified.
- backend/collections/id.php — PATCH already supports status field with valid statuses including DELIVERED. Returns updated collection.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edited finals upload zone, edited photos grid, and Mark as Delivered button</name>
  <files>
    frontend/src/pages/CollectionDetailsPage.jsx
    frontend/src/locales/en.json
    frontend/src/locales/lt.json
    frontend/src/locales/ru.json
  </files>
  <action>
Extend CollectionDetailsPage.jsx with three additions:

**1. Edited photos state and fetch:**
- Add `const [editedPhotos, setEditedPhotos] = useState([]);`
- Add `const editedFileInputRef = useRef(null);`
- Add useEffect to fetch edited photos from `GET /collections/${id}/edited` with `credentials: 'include'`. On success, `setEditedPhotos(data.editedPhotos || [])`. Non-critical failure — catch silently. Only fetch when collection status is REVIEWING or DELIVERED.

**2. Edited files upload handler:**
Reuse the existing `uploadFiles` pattern but target the `/edited` endpoint. Create `uploadEditedFiles` function:
- Same validation (ALLOWED_TYPES, MAX_FILE_SIZE)
- Same concurrency limiter (MAX_CONCURRENT_UPLOADS)
- POST each file as FormData to `${VITE_API_BASE_URL}/collections/${id}/edited`
- Track upload states in a separate state object: `const [editedUploadStates, setEditedUploadStates] = useState({})`
- After all uploads complete, re-fetch edited photos list via GET
- On success, show `toast.success(t('collection.editedUploadSuccess'))`
- Create `handleEditedFileChange` that calls `uploadEditedFiles(e.target.files)` and resets input value

**3. Render edited upload zone and grid (REVIEWING status only):**
Place AFTER the photo grid card, BEFORE the lightbox. Only render when `collection.status === 'REVIEWING'`:

```jsx
{collection.status === 'REVIEWING' && (
  <div className="bg-white border border-gray-200 rounded-[10px] px-6 py-5 mb-5">
    <h2 className="mt-0 mb-4 text-sm font-bold text-gray-700 uppercase tracking-[0.05em]">
      {t('collection.editedFinalsTitle')}
      {editedPhotos.length > 0 && (
        <span className="ml-2 text-xs font-normal text-gray-400 normal-case tracking-normal">
          {t('collection.editedPhotosCount', { count: editedPhotos.length })}
        </span>
      )}
    </h2>

    {/* Green-themed drop zone */}
    <div
      role="button"
      tabIndex={0}
      aria-label={t('collection.editedUploadZoneLabel')}
      onClick={() => editedFileInputRef.current?.click()}
      onKeyDown={(e) => e.key === 'Enter' && editedFileInputRef.current?.click()}
      className="border-2 border-dashed rounded-[10px] flex flex-col items-center justify-center gap-2 py-10 cursor-pointer transition-colors select-none border-green-300 bg-green-50 hover:border-green-400"
    >
      <svg className="w-9 h-9 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
      </svg>
      <p className="m-0 text-sm font-medium text-gray-600">
        {t('collection.editedUploadZoneLabel')}
      </p>
      <p className="m-0 text-xs text-gray-400">
        {t('collection.editedUploadZoneHint')}
      </p>
    </div>

    <input
      ref={editedFileInputRef}
      type="file"
      accept="image/jpeg,image/png,image/webp"
      multiple
      className="hidden"
      onChange={handleEditedFileChange}
    />

    {/* Edited photos grid */}
    {editedPhotos.length > 0 && (
      <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
        {editedPhotos.map((photo) => (
          <div key={photo.id} className="relative group aspect-square rounded-[6px] overflow-hidden bg-gray-100">
            <img
              src={photoUrl(photo.storagePath)}
              alt={photo.filename}
              className="w-full h-full object-cover"
              loading="lazy"
            />
          </div>
        ))}
      </div>
    )}
  </div>
)}
```

**4. Add "Mark as Delivered" button:**
In the Collection Info Card, AFTER the existing "Start client selection" button conditional, add:

```jsx
{collection.status === 'REVIEWING' && (
  <button
    onClick={handleMarkAsDelivered}
    disabled={editedPhotos.length === 0}
    className={`inline-flex items-center gap-2 py-[9px] px-[22px] text-[14px] font-semibold text-white border-none rounded-[6px] cursor-pointer font-sans transition-opacity duration-150 ${
      editedPhotos.length > 0
        ? 'bg-[linear-gradient(135deg,#10b981,#059669)] hover:opacity-[0.88]'
        : 'bg-gray-300 cursor-not-allowed opacity-60'
    }`}
  >
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
    </svg>
    {t('collection.markAsDelivered')}
  </button>
)}
```

Create `handleMarkAsDelivered` handler:
- PATCH `/collections/${id}` with `{ status: 'DELIVERED' }` (same pattern as handleStartSelecting)
- On success: `setCollection(data.collection)` and `toast.success(t('collection.markedAsDelivered'))`
- On error: `toast.error(t('collection.statusUpdateError'))` (reuse existing key)

**5. Add i18n keys to all 3 locale files:**

In `collection` namespace of en.json (after the filter keys added in 04-01):
```json
"editedFinalsTitle": "Edited Finals",
"editedPhotosCount_one": "{{count}} file",
"editedPhotosCount_other": "{{count}} files",
"editedUploadZoneLabel": "Upload edited finals here",
"editedUploadZoneHint": "JPEG, PNG or WEBP · Max 20 MB per file",
"editedUploadSuccess": "Edited photos uploaded!",
"markAsDelivered": "Mark as Delivered",
"markedAsDelivered": "Collection marked as delivered!"
```

In lt.json (Lithuanian):
```json
"editedFinalsTitle": "Galutiniai failai",
"editedPhotosCount_one": "{{count}} failas",
"editedPhotosCount_other": "{{count}} failai",
"editedUploadZoneLabel": "Ikelkite galutinius failus",
"editedUploadZoneHint": "JPEG, PNG arba WEBP · Maks. 20 MB failui",
"editedUploadSuccess": "Galutiniai failai ikelti!",
"markAsDelivered": "Pazymeti kaip pristatyta",
"markedAsDelivered": "Kolekcija pazymeta kaip pristatyta!"
```

In ru.json (Russian):
```json
"editedFinalsTitle": "Готовые файлы",
"editedPhotosCount_one": "{{count}} файл",
"editedPhotosCount_other": "{{count}} файлов",
"editedUploadZoneLabel": "Загрузите готовые файлы сюда",
"editedUploadZoneHint": "JPEG, PNG или WEBP · Макс. 20 МБ на файл",
"editedUploadSuccess": "Готовые файлы загружены!",
"markAsDelivered": "Отметить как доставлено",
"markedAsDelivered": "Коллекция отмечена как доставленная!"
```

Place these keys after the filter keys in the `collection` namespace.
  </action>
  <verify>
1. Run `cd frontend && npm run lint` — zero warnings
2. Run `cd frontend && npm run build` — successful build
3. Grep for `editedFinalsTitle` in all 3 locale files — present
4. Grep for `editedPhotos` in CollectionDetailsPage.jsx — present
5. Grep for `handleMarkAsDelivered` in CollectionDetailsPage.jsx — present
6. Grep for `DELIVERED` in CollectionDetailsPage.jsx — present in handleMarkAsDelivered
  </verify>
  <done>
- Edited finals upload zone appears in REVIEWING status with green theme
- Uploaded edited photos display in a grid below the upload zone
- "Mark as Delivered" button appears in REVIEWING status
- Button is disabled when no edited photos exist
- Clicking the button transitions collection to DELIVERED status
- All i18n keys present in EN, LT, RU
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete delivery workflow</name>
  <what-built>
Edited finals upload zone (green-themed) on CollectionDetailsPage in REVIEWING status, edited photos grid, and "Mark as Delivered" button that transitions collection to DELIVERED status.
  </what-built>
  <how-to-verify>
1. Open a collection in REVIEWING status at /collection/{id}
2. Verify the green "Edited Finals" upload zone appears below the photo grid
3. Upload 1-2 edited photos — they should appear in a grid below the upload zone
4. Verify the "Mark as Delivered" button in the info card is now enabled (green gradient)
5. Click "Mark as Delivered" — status badge should change to DELIVERED (purple)
6. Verify the edited upload zone disappears after DELIVERED transition
7. Navigate to /collections — verify the collection card shows correct status badge
8. Open a DRAFT collection — verify no edited upload zone appears
9. Check that the "Mark as Delivered" button was disabled before uploading any edited photos
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero warnings
2. `npm run build` succeeds
3. Edited upload zone renders only in REVIEWING status
4. Edited photos upload via POST /collections/{id}/edited and display in grid
5. "Mark as Delivered" button disabled until edited photos exist
6. Status transitions to DELIVERED via PATCH
7. All i18n keys in 3 locales
</verification>

<success_criteria>
- Photographer can upload edited final versions of photos (DELIV-01)
- Collection transitions to DELIVERED status after finals uploaded
- Edited upload zone is visually distinct (green theme) from proofs upload (blue/gray)
- DELIVERED button has proper guard (disabled without edited photos)
- REVIEW-03 verified (green border on REVIEWING collection card — from Phase 2)
</success_criteria>

<output>
After completion, create `.planning/phases/04-review-and-delivery/04-02-SUMMARY.md`
</output>
