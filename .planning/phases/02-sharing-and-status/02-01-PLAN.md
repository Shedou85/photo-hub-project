---
phase: 02-sharing-and-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/index.php
  - backend/collections/share.php
  - frontend/src/App.jsx
  - frontend/src/pages/SharePage.jsx
  - frontend/src/pages/CollectionDetailsPage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: true

must_haves:
  truths:
    - "Visiting /share/{shareId} in the browser shows the collection name and photo grid without requiring login"
    - "Photographer can copy the share link from the collection detail page with one click"
    - "The share page does not expose userId, password, clientEmail or other private fields"
  artifacts:
    - path: "backend/collections/share.php"
      provides: "Public GET endpoint that returns collection metadata and photos by shareId"
      contains: "shareId"
    - path: "frontend/src/pages/SharePage.jsx"
      provides: "Public page rendering collection name, photo count, and thumbnail grid"
      contains: "shareId"
    - path: "frontend/src/App.jsx"
      provides: "Route definition for /share/:shareId outside ProtectedRoute"
      contains: "/share/:shareId"
  key_links:
    - from: "frontend/src/pages/SharePage.jsx"
      to: "backend/collections/share.php"
      via: "fetch to VITE_API_BASE_URL/share/{shareId}"
      pattern: "fetch.*share"
    - from: "frontend/src/App.jsx"
      to: "frontend/src/pages/SharePage.jsx"
      via: "Route path=/share/:shareId"
      pattern: "share.*SharePage"
    - from: "backend/index.php"
      to: "backend/collections/share.php"
      via: "strpos dispatch in default block"
      pattern: "share"
---

<objective>
Wire the existing shareId token to a public backend endpoint and a public frontend page so that a client can view a collection via share link without logging in. Also add a "Copy share link" button to the collection detail page.

Purpose: Delivers SHARE-01 (photographer generates shareable link) and SHARE-02 (client accesses collection via link without account). The shareId already exists on every collection — this plan connects the existing token to a public read-only view.

Output: `backend/collections/share.php` (public endpoint), `SharePage.jsx` (public React page), updated `App.jsx` route, share button on `CollectionDetailsPage.jsx`, i18n keys in all 3 locale files.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sharing-and-status/02-RESEARCH.md

Key existing code:
- backend/index.php — main router; new /share/ route goes in the default: block BEFORE the 404 fallback
- backend/collections/id.php — pattern for extracting collection ID from URI and querying DB
- backend/collections/index.php — line 49: `$shareId = bin2hex(random_bytes(8))` already generates shareId at creation
- backend/cors.php — CORS headers; already allows non-credentialed requests (no credential check in origin matching)
- frontend/src/App.jsx — public routes at top level, protected routes inside ProtectedRoute wrapper
- frontend/src/pages/CollectionDetailsPage.jsx — needs share button added to info card
- frontend/src/pages/CollectionsListPage.jsx — lines 127-134: existing handleShareCollection pattern to reuse
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend public share endpoint and router registration</name>
  <files>backend/collections/share.php, backend/index.php</files>
  <action>
Create `backend/collections/share.php` — a public GET handler that returns collection metadata and photos by shareId. This endpoint must NOT require session authentication (no `session_start()`, no `$_SESSION` check).

**share.php implementation:**
1. `require_once __DIR__ . '/../db.php';` and `require_once __DIR__ . '/../utils.php';`
2. Only allow GET method. Return 405 for anything else.
3. Parse the shareId from the URL using `parseRouteParts()`. For URL `/share/{shareId}`, `$parts[1]` is the shareId. Validate shareId is not empty.
4. Query: `SELECT id, name, status, clientName, shareId, coverPhotoId, createdAt FROM Collection WHERE shareId = ? LIMIT 1` — explicitly exclude `userId`, `password`, `clientEmail`, `processedZipPath`, `expiresAt`, `allowPromotionalUse` and other sensitive fields.
5. If no collection found, return 404 with `{"error": "Collection not found."}`.
6. Query photos: `SELECT id, filename, storagePath, thumbnailPath, createdAt FROM Photo WHERE collectionId = ? ORDER BY createdAt ASC`.
7. Attach photos array to collection object: `$collection['photos'] = $photos;`
8. Return: `{"status": "OK", "collection": $collection}`
9. Wrap in try/catch for Throwable, return 500 on error.

**Router registration in backend/index.php:**
In the `default:` case block, BEFORE the existing `if (strpos($requestUri, '/collections/') === 0)` block, add:

```php
if (strpos($requestUri, '/share/') === 0) {
    if ($requestMethod === 'GET') {
        require_once __DIR__ . '/collections/share.php';
    } else {
        http_response_code(405);
        echo json_encode(['error' => 'Method Not Allowed']);
    }
    break;
}
```

This must go BEFORE the `/collections/` block so it matches first.
  </action>
  <verify>
Run: `curl -s https://api.pixelforge.pro/backend/share/nonexistent | head` — should return 404 JSON.
Or locally: verify the PHP file has no syntax errors with `php -l backend/collections/share.php`.
  </verify>
  <done>
GET /share/{validShareId} returns 200 with collection metadata (name, status, clientName, coverPhotoId, createdAt) plus photos array. No userId, password, or clientEmail in response. GET /share/{invalidShareId} returns 404. Non-GET methods return 405.
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend SharePage, route registration, share button on detail page, and i18n</name>
  <files>frontend/src/pages/SharePage.jsx, frontend/src/App.jsx, frontend/src/pages/CollectionDetailsPage.jsx, frontend/src/locales/en.json, frontend/src/locales/lt.json, frontend/src/locales/ru.json</files>
  <action>
**1. Create `frontend/src/pages/SharePage.jsx`:**

A public page component that fetches collection data from the share endpoint and renders a read-only gallery. No authentication required. No sidebar (not wrapped in MainLayout).

Structure:
- Use `useParams()` to get `shareId` from the URL.
- Use `useTranslation()` for all strings.
- State: `collection` (null initially), `loading` (true), `error` (null), `lightboxIndex` (null for lightbox).
- On mount (useEffect), fetch `${import.meta.env.VITE_API_BASE_URL}/share/${shareId}` — WITHOUT `credentials: "include"` (this is a public endpoint, no session cookie needed).
- If response not ok or collection not found, show error state.
- Render: collection name as h1, clientName if set, photo count, and a responsive thumbnail grid (reuse the same grid pattern from CollectionDetailsPage — `grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2` with aspect-square thumbnails).
- Include a lightbox for fullscreen photo viewing (same pattern as CollectionDetailsPage: click thumbnail opens lightbox, arrow keys for prev/next, Escape to close, prev/next buttons, close button, counter).
- Use the `photoUrl()` helper (same pattern: `${VITE_API_BASE_URL}/${path}`).
- Show `thumbnailPath ?? storagePath` for grid images, `storagePath` for lightbox.
- Styling: clean minimal page, centered content with `max-w-[720px] mx-auto`, white background, no sidebar. Include a small PixelForge branding text at bottom ("Powered by PixelForge" or similar via i18n key).
- Loading state: show `t('share.loading')`.
- Error/not found state: show `t('share.notFound')`.

**2. Register route in `App.jsx`:**

Add `import SharePage from './pages/SharePage';` at the top with other page imports.

Add a public route BEFORE the ProtectedRoute block:
```jsx
<Route path="/share/:shareId" element={<SharePage />} />
```
Place it after the `/login` route and before the ProtectedRoute wrapper. This route must NOT be wrapped in ProtectedRoute or MainLayout.

**3. Add share button to `CollectionDetailsPage.jsx`:**

In the collection info card (the `<div className="bg-white border border-gray-200 rounded-[10px] px-6 py-5 mb-5">` that contains the "Created:" info), add a "Copy share link" button.

Add a `handleCopyShareLink` function:
```jsx
const handleCopyShareLink = () => {
  const url = `${window.location.origin}/share/${collection.shareId}`;
  navigator.clipboard.writeText(url).then(() => {
    toast.success(t('collection.linkCopied'));
  });
};
```

Add a button in the info card, below the existing grid of InfoRows, with styling matching the project's blue gradient button pattern:
```jsx
<button
  onClick={handleCopyShareLink}
  className="mt-4 inline-flex items-center gap-2 py-[9px] px-[22px] text-[14px] font-semibold text-white bg-[linear-gradient(135deg,#3b82f6,#6366f1)] border-none rounded-[6px] cursor-pointer font-sans transition-opacity duration-150 hover:opacity-[0.88]"
>
  {/* Share icon SVG (same as CollectionsListPage) */}
  {t('collection.copyShareLink')}
</button>
```

Include the share icon SVG (the share/link icon from CollectionsListPage line 253-255).

**4. Add i18n keys to ALL THREE locale files:**

**en.json** — add to `"share"` namespace (new top-level key) and `"collection"` namespace:
```json
"share": {
  "loading": "Loading gallery...",
  "notFound": "This gallery could not be found or may no longer be available.",
  "photos": "Photos",
  "photosCount_one": "{{count}} photo",
  "photosCount_other": "{{count}} photos",
  "poweredBy": "Powered by PixelForge",
  "lightboxClose": "Close",
  "lightboxPrev": "Previous photo",
  "lightboxNext": "Next photo"
},
"collection": {
  ... (existing keys),
  "copyShareLink": "Copy share link",
  "linkCopied": "Share link copied!"
}
```

**lt.json** — add to `"share"` namespace:
```json
"share": {
  "loading": "Kraunama galerija...",
  "notFound": "Ši galerija nerasta arba gali būti nebepasiekiama.",
  "photos": "Nuotraukos",
  "photosCount_one": "{{count}} nuotrauka",
  "photosCount_few": "{{count}} nuotraukos",
  "photosCount_many": "{{count}} nuotraukų",
  "photosCount_other": "{{count}} nuotraukų",
  "poweredBy": "Sukurta su PixelForge",
  "lightboxClose": "Uždaryti",
  "lightboxPrev": "Ankstesnė nuotrauka",
  "lightboxNext": "Kita nuotrauka"
},
"collection": {
  ... (existing keys),
  "copyShareLink": "Kopijuoti nuorodą",
  "linkCopied": "Nuoroda nukopijuota!"
}
```

**ru.json** — add to `"share"` namespace:
```json
"share": {
  "loading": "Загрузка галереи...",
  "notFound": "Эта галерея не найдена или больше недоступна.",
  "photos": "Фотографии",
  "photosCount_one": "{{count}} фото",
  "photosCount_few": "{{count}} фото",
  "photosCount_many": "{{count}} фото",
  "photosCount_other": "{{count}} фото",
  "poweredBy": "Создано с PixelForge",
  "lightboxClose": "Закрыть",
  "lightboxPrev": "Предыдущее фото",
  "lightboxNext": "Следующее фото"
},
"collection": {
  ... (existing keys),
  "copyShareLink": "Скопировать ссылку",
  "linkCopied": "Ссылка скопирована!"
}
```

IMPORTANT: The share page fetch must NOT include `credentials: "include"`. This is a public endpoint — the client has no session. Use a plain `fetch()` without the credentials option.
  </action>
  <verify>
1. `cd frontend && npm run lint` — passes with zero warnings.
2. `cd frontend && npm run build` — builds without errors.
3. Manual: navigate to `/share/{validShareId}` in browser — should render collection name and photo grid without requiring login.
  </verify>
  <done>
SharePage renders at /share/:shareId showing collection name, photo count, thumbnail grid, and lightbox. No login required. Collection detail page has a "Copy share link" button. All i18n keys present in en.json, lt.json, and ru.json.
  </done>
</task>

</tasks>

<verification>
1. Backend: `GET /share/{shareId}` returns collection metadata + photos without auth; 404 for invalid tokens; no sensitive fields exposed.
2. Frontend: `/share/:shareId` route renders SharePage outside ProtectedRoute/MainLayout.
3. SharePage: Shows collection name, client name (if set), photo count, thumbnail grid, lightbox navigation.
4. CollectionDetailsPage: Has "Copy share link" button that copies URL to clipboard with toast feedback.
5. i18n: All new keys present in en.json, lt.json, ru.json under `share` and `collection` namespaces.
6. ESLint: `npm run lint` passes with zero warnings.
7. Build: `npm run build` succeeds.
</verification>

<success_criteria>
- Client can visit /share/{shareId} and see the collection gallery without logging in.
- Photographer can copy the share link from the collection detail page with one click.
- Public share endpoint does not leak sensitive data (userId, password, clientEmail).
- All strings are internationalized (EN, LT, RU).
- ESLint and build pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-sharing-and-status/02-01-SUMMARY.md`
</output>
