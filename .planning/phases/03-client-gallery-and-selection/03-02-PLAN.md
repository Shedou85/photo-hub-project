---
phase: 03-client-gallery-and-selection
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/pages/SharePage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: false

must_haves:
  truths:
    - "Client can toggle individual photos as selected or not selected by clicking on them"
    - "Selected photos show a blue checkbox overlay in the top-right corner"
    - "Client sees a running count badge showing how many photos are selected"
    - "Selections persist across page reload (initialized from API response)"
    - "Client cannot right-click save or drag-to-save photos when status is SELECTING"
    - "Selection checkboxes only appear when collection status is SELECTING"
    - "Rapid clicking on same photo does not cause errors (in-flight request guard)"
    - "Selection toggle in lightbox view works the same as in grid view"
  artifacts:
    - path: "frontend/src/pages/SharePage.jsx"
      provides: "Selection UI with optimistic updates, checkbox overlay, counter badge, download prevention"
      min_lines: 100
    - path: "frontend/src/locales/en.json"
      provides: "Selection-related i18n keys in share namespace"
      contains: "selectedCount"
    - path: "frontend/src/locales/lt.json"
      provides: "Lithuanian selection translations with proper pluralization"
      contains: "selectedCount"
    - path: "frontend/src/locales/ru.json"
      provides: "Russian selection translations with proper pluralization"
      contains: "selectedCount"
  key_links:
    - from: "frontend/src/pages/SharePage.jsx"
      to: "/share/{shareId}/selections"
      via: "fetch POST/DELETE in toggleSelection function"
      pattern: "share.*selections"
    - from: "frontend/src/pages/SharePage.jsx"
      to: "collection.selections"
      via: "useState initialization from share endpoint response"
      pattern: "selectedPhotoIds"
    - from: "frontend/src/pages/SharePage.jsx"
      to: "i18n share namespace"
      via: "t() calls for selection strings"
      pattern: "t\\(.*share\\."
---

<objective>
Add interactive photo selection UI to SharePage with optimistic updates, running counter, and download prevention.

Purpose: This is the core client-facing feature — the client opens the share link, sees photos, and clicks to select favorites. The selection state must feel instant (optimistic updates), persist across reloads, and prevent casual photo downloading.

Output: Extended SharePage.jsx with selection functionality, updated i18n files for all three languages.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-gallery-and-selection/03-01-SUMMARY.md
@frontend/src/pages/SharePage.jsx
@frontend/src/locales/en.json
@frontend/src/locales/lt.json
@frontend/src/locales/ru.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state, toggle logic, UI overlays, counter badge, download prevention, and i18n</name>
  <files>frontend/src/pages/SharePage.jsx, frontend/src/locales/en.json, frontend/src/locales/lt.json, frontend/src/locales/ru.json</files>
  <action>
**SharePage.jsx — Add selection state and API integration:**

1. Add new state variables after existing ones:
```javascript
const [selectedPhotoIds, setSelectedPhotoIds] = useState(new Set());
const [requestsInFlight, setRequestsInFlight] = useState(new Set());
```

2. In the existing `fetchCollection` useEffect, after `setCollection(data.collection)` and `setPhotos(data.collection.photos || [])`, initialize selections from the response:
```javascript
// Initialize selections from share endpoint response (added by 03-01)
const initialSelections = new Set(
  (data.collection.selections || []).map(s => s.photoId)
);
setSelectedPhotoIds(initialSelections);
```
This avoids a separate API call since 03-01 added `selections` to the share response.

3. Add `toggleSelection` function with optimistic updates and in-flight guard:
```javascript
const toggleSelection = async (photoId) => {
  if (requestsInFlight.has(photoId)) return; // Prevent rapid-click race conditions

  const wasSelected = selectedPhotoIds.has(photoId);

  // Optimistic update
  setSelectedPhotoIds(prev => {
    const next = new Set(prev);
    wasSelected ? next.delete(photoId) : next.add(photoId);
    return next;
  });

  // Mark request in-flight
  setRequestsInFlight(prev => new Set(prev).add(photoId));

  try {
    const baseUrl = import.meta.env.VITE_API_BASE_URL;
    if (wasSelected) {
      const res = await fetch(`${baseUrl}/share/${shareId}/selections/${photoId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error('Deselect failed');
    } else {
      const res = await fetch(`${baseUrl}/share/${shareId}/selections`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ photoId }),
      });
      if (!res.ok) throw new Error('Select failed');
    }
  } catch {
    // Rollback on error
    setSelectedPhotoIds(prev => {
      const rollback = new Set(prev);
      wasSelected ? rollback.add(photoId) : rollback.delete(photoId);
      return rollback;
    });
    toast.error(t('share.selectionError'));
  } finally {
    setRequestsInFlight(prev => {
      const next = new Set(prev);
      next.delete(photoId);
      return next;
    });
  }
};
```

4. Add `import { toast } from 'sonner'` at the top (if not already imported).

5. Derive helper booleans:
```javascript
const canSelect = collection?.status === 'SELECTING';
```

**SharePage.jsx — Selection counter badge:**

In the header section, after the photo count line (`share.photosCount`), add the selection counter badge. Only show when `canSelect` is true AND `selectedPhotoIds.size > 0`:

```jsx
{canSelect && selectedPhotoIds.size > 0 && (
  <div className="mt-3 inline-flex items-center gap-2 py-[6px] px-[14px] bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">
    <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
      <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
    </svg>
    {t('share.selectedCount', { count: selectedPhotoIds.size })}
  </div>
)}
```

**SharePage.jsx — Photo grid with checkbox overlay and download prevention:**

Replace the existing photo grid item rendering (the `<div key={photo.id}>` block inside the `.map()`) with:

```jsx
{photos.map((photo, index) => {
  const isSelected = selectedPhotoIds.has(photo.id);
  return (
    <div
      key={photo.id}
      className={`relative group aspect-square rounded-[6px] overflow-hidden bg-gray-100 cursor-pointer ${
        isSelected ? 'ring-2 ring-blue-500 ring-offset-1' : ''
      }`}
      onClick={() => canSelect ? toggleSelection(photo.id) : setLightboxIndex(index)}
    >
      <img
        src={photoUrl(photo.thumbnailPath ?? photo.storagePath)}
        alt={photo.filename}
        className="w-full h-full object-cover select-none"
        loading="lazy"
        onContextMenu={(e) => e.preventDefault()}
        draggable={false}
      />

      {/* Checkbox overlay — only in SELECTING status */}
      {canSelect && (
        <div className={`absolute top-2 right-2 w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors ${
          isSelected
            ? 'bg-blue-600 border-blue-600'
            : 'bg-white/80 border-gray-300 group-hover:border-blue-400'
        }`}>
          {isSelected && (
            <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
            </svg>
          )}
        </div>
      )}

      {/* Lightbox open button — show magnifying glass on hover in SELECTING mode */}
      {canSelect && (
        <button
          onClick={(e) => { e.stopPropagation(); setLightboxIndex(index); }}
          className="absolute bottom-2 left-2 w-7 h-7 rounded-full bg-black/50 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
          aria-label={t('share.viewPhoto')}
        >
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </button>
      )}
    </div>
  );
})}
```

Key behavior:
- When `canSelect` is true (SELECTING status): clicking the photo TOGGLES selection. A separate magnifying glass button opens the lightbox.
- When `canSelect` is false (any other status): clicking the photo opens the lightbox (same as before).
- Download prevention (`onContextMenu`, `draggable={false}`, `select-none`) is ALWAYS on — photos are never downloadable from the share page regardless of status.
- Selected photos get a `ring-2 ring-blue-500` border for visual feedback.

**SharePage.jsx — Lightbox selection toggle:**

In the lightbox overlay, add a selection toggle button. Place it next to the existing close button area, in the top-left corner:

```jsx
{/* Selection toggle in lightbox */}
{canSelect && lightboxIndex !== null && photos[lightboxIndex] && (
  <button
    onClick={(e) => {
      e.stopPropagation();
      toggleSelection(photos[lightboxIndex].id);
    }}
    className={`absolute top-4 left-4 flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors z-10 ${
      selectedPhotoIds.has(photos[lightboxIndex].id)
        ? 'bg-blue-600 text-white'
        : 'bg-white/20 text-white hover:bg-white/30'
    }`}
  >
    <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
    </svg>
    {selectedPhotoIds.has(photos[lightboxIndex].id) ? t('share.selected') : t('share.select')}
  </button>
)}
```

Also add download prevention to the lightbox image:
```jsx
onContextMenu={(e) => e.preventDefault()}
draggable={false}
```
Add `select-none` to the lightbox image's className.

**i18n keys — Add to ALL THREE locale files in the `share` namespace:**

**en.json** — add these keys inside the `"share"` object:
```json
"selectedCount_one": "{{count}} photo selected",
"selectedCount_other": "{{count}} photos selected",
"selectionError": "Failed to update selection. Please try again.",
"select": "Select",
"selected": "Selected",
"viewPhoto": "View photo"
```

**lt.json** — add these keys inside the `"share"` object:
```json
"selectedCount_one": "{{count}} nuotrauka pasirinkta",
"selectedCount_few": "{{count}} nuotraukos pasirinktos",
"selectedCount_many": "{{count}} nuotraukų pasirinkta",
"selectedCount_other": "{{count}} nuotraukų pasirinkta",
"selectionError": "Nepavyko atnaujinti pasirinkimo. Bandykite dar kartą.",
"select": "Pasirinkti",
"selected": "Pasirinkta",
"viewPhoto": "Peržiūrėti nuotrauką"
```

**ru.json** — add these keys inside the `"share"` object:
```json
"selectedCount_one": "{{count}} фото выбрано",
"selectedCount_few": "{{count}} фото выбрано",
"selectedCount_many": "{{count}} фото выбрано",
"selectedCount_other": "{{count}} фото выбрано",
"selectionError": "Не удалось обновить выбор. Попробуйте ещё раз.",
"select": "Выбрать",
"selected": "Выбрано",
"viewPhoto": "Посмотреть фото"
```

**Important implementation notes:**
- Use `toast` from `sonner` for error notifications (already used elsewhere in the project)
- The `select-none` Tailwind class maps to `user-select: none` — prevents alt-text selection
- `draggable={false}` prevents drag-to-desktop saving
- `onContextMenu={(e) => e.preventDefault()}` blocks right-click "Save image as"
- Do NOT add `-webkit-touch-callout: none` via inline styles — stick to Tailwind utilities per project conventions
- Optimistic updates: UI changes BEFORE API call completes; rolls back on error
- In-flight guard: `requestsInFlight` Set prevents the same photo from being toggled while a request is pending
  </action>
  <verify>
1. Run `npm run lint` from `frontend/` directory — zero warnings
2. Run `npm run build` from `frontend/` directory — builds successfully
3. Verify all three locale files have `selectedCount` keys: grep for "selectedCount" in en.json, lt.json, ru.json
4. Verify `toggleSelection` function exists in SharePage.jsx
5. Verify `requestsInFlight` guard exists in SharePage.jsx
6. Verify `onContextMenu` exists on both grid and lightbox images
7. Verify `toast` import exists in SharePage.jsx
  </verify>
  <done>
- Clicking a photo in SELECTING status toggles its selection with optimistic UI update
- Selected photos show blue checkbox overlay and ring border
- Running counter badge shows selected count with correct i18n pluralization
- Lightbox has selection toggle button
- Right-click and drag-to-save are blocked on all images
- Selection checkboxes only appear when status is SELECTING
- Rapid clicks on same photo are guarded by in-flight Set
- All i18n keys present in en.json, lt.json, ru.json
- ESLint and build pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify selection flow end-to-end</name>
  <what-built>
Complete client selection flow: backend API for selections (public, token-based, status-gated) and frontend UI with optimistic selection toggles, running counter, checkbox overlays, lightbox selection, and download prevention.
  </what-built>
  <how-to-verify>
**Prerequisites:** You need a collection in SELECTING status with uploaded photos and a share link.

1. **Open the share link** in a browser (or incognito to simulate a client)
2. **Verify photo grid** loads with all photos
3. **Click a photo** — verify:
   - Blue checkbox appears instantly in top-right corner
   - Blue ring border appears around the photo
   - Counter badge appears in header showing "1 photo selected"
4. **Click two more photos** — verify counter updates to "3 photos selected"
5. **Click a selected photo again** — verify it deselects (checkbox and ring disappear, counter decrements)
6. **Refresh the page** — verify selections persist (counter shows correct count, checkboxes are in correct state)
7. **Open lightbox** by clicking the magnifying glass icon on a photo — verify:
   - Selection button visible in top-left corner
   - Can toggle selection from within lightbox
   - Selection state updates in grid after closing lightbox
8. **Right-click on a photo** — verify context menu does NOT appear
9. **Try to drag a photo** to desktop — verify it does NOT download
10. **Test rapid clicking** — quickly click the same photo 5 times — verify no errors in console, final state is correct

**If collection is in DRAFT or REVIEWING status:**
11. Open the share link — verify checkboxes do NOT appear (no selection UI)
12. Clicking a photo should open the lightbox (not toggle selection)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Backend: `php -l backend/collections/share-selections.php` and `php -l backend/collections/share.php` pass
2. Frontend: `npm run lint` and `npm run build` pass in `frontend/`
3. Selection API: POST/DELETE return 403 when status != SELECTING; GET always works
4. SharePage: selection toggle with optimistic updates, in-flight guard, rollback on error
5. SharePage: checkbox overlay visible only in SELECTING status
6. SharePage: running counter badge with correct pluralization in all 3 languages
7. SharePage: download prevention on grid and lightbox images
8. i18n: all selection keys present in en.json, lt.json, ru.json
</verification>

<success_criteria>
- Client can toggle photos as selected/not-selected by clicking them
- Selected photos show visual indicators (checkbox + ring border)
- Running counter badge displays correct selected count
- Selections persist across page reload
- Right-click and drag-to-save are blocked
- Selection UI only appears when collection status is SELECTING
- No race conditions on rapid clicking
- All strings internationalized (EN, LT, RU)
- ESLint and build pass with zero warnings
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-gallery-and-selection/03-02-SUMMARY.md`
</output>
