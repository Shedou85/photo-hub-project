---
phase: 01-photo-upload
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - frontend/src/pages/CollectionDetailsPage.jsx
autonomous: false

must_haves:
  truths:
    - "Lightbox opens and displays full-resolution image for any photo in the grid"
    - "Keyboard navigation works: ArrowLeft, ArrowRight, Escape to close"
    - "Photo counter displays correct current/total count"
    - "Cover photo is visually distinguished in the grid with a clear badge or indicator"
    - "Clicking set-cover button on any photo changes the cover and updates the badge immediately"
    - "Deleting a photo that is the collection cover automatically promotes the next photo as new cover"
  artifacts:
    - path: "frontend/src/pages/CollectionDetailsPage.jsx"
      provides: "Custom lightbox component, cover badge styling, cover set/delete logic"
      min_lines: 100
  key_links:
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "lightbox overlay"
      via: "Image click opens lightbox with full-resolution storagePath"
      pattern: "onClick.*setLightbox.*lightbox"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "cover badge"
      via: "Collection coverPhotoId determines which photo shows cover indicator"
      pattern: "coverPhotoId.*badge"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "delete handler"
      via: "If deleted photo is cover, promote next photo as new cover"
      pattern: "deletePhoto.*coverPhotoId"
---

<objective>
Verify and polish the custom lightbox component and cover photo management UI to ensure they work end-to-end with backend changes from plans 01-01 and 01-02.

Purpose: Ensure the photographer has a high-quality viewing experience with working lightbox navigation and clear visual feedback for which photo is the collection cover. Ensure deleting the cover photo automatically promotes the next photo.

Output: Verified and polished lightbox with working keyboard shortcuts, functional cover badge and set-cover UI, automatic cover promotion on deletion.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-photo-upload/01-RESEARCH.md
@.planning/phases/01-photo-upload/01-CONTEXT.md
@.planning/phases/01-photo-upload/01-01-SUMMARY.md
@.planning/phases/01-photo-upload/01-02-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify lightbox navigation and ensure cover badge displays correctly with thumbnails</name>
  <files>frontend/src/pages/CollectionDetailsPage.jsx</files>
  <action>
    1. Open frontend/src/pages/CollectionDetailsPage.jsx and locate the lightbox component code (approx. lines 471–526 per research notes).
    2. Verify that the lightbox:
       - Opens when a photo is clicked (check onClick handler on photo cards)
       - Displays the full-resolution image via photo.storagePath
       - Shows prev/next arrows for navigation
       - Displays a photo counter (e.g., "3 of 10")
       - Closes on Escape or close button click
    3. Locate the cover badge rendering (the gradient star or similar indicator that shows on the photo matching collection.coverPhotoId).
    4. Verify that the badge is visible on the correct photo after:
       - First photo upload (auto-set cover from Task 01-02)
       - Manual set-cover click
       - Photo deletion and cover promotion
    5. Review the grid rendering: ensure the badge is overlaid correctly and visible on thumbnail images (not hidden behind other elements).
    6. If the badge uses any hard-coded colors or styles, verify they are Tailwind classes (no inline styles except where dynamic JS values are unavoidable).

    Locked decision: Claude's discretion on visual style — badge, border, or highlight. Research notes use a "gradient star" approach; verify this is aesthetically correct and visible on thumbnails.
  </action>
  <verify>
    - Lightbox opens on photo click with full-resolution image from storagePath
    - ArrowLeft/ArrowRight keys navigate between photos in lightbox
    - Escape key closes lightbox
    - Photo counter displays correctly (e.g., "1 of 5", "5 of 5")
    - Cover badge is visible on the correct photo in the grid
    - Badge position and styling (Tailwind classes) are correct
    - Badge appears immediately after first upload and after set-cover clicks
  </verify>
  <done>
    Lightbox component is verified functional with working navigation and close controls. Cover badge displays correctly on the cover photo in the grid. All styles use Tailwind utilities.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify set-cover button functionality and automatic cover promotion on deletion</name>
  <files>frontend/src/pages/CollectionDetailsPage.jsx</files>
  <action>
    1. Locate the set-cover button in the hover overlay on each photo card (should call PATCH /collections/:id/cover with the photoId).
    2. Verify the button:
       - Is visible on hover
       - Calls the correct API endpoint with correct photoId
       - Updates the collection state (collection.coverPhotoId)
       - The cover badge moves to the newly selected photo immediately
       - No errors in console
    3. Locate the delete photo handler (the function that calls DELETE /collections/:id/photos/:photoId).
    4. After a successful delete, add logic to handle cover photo promotion:
       - If the deleted photo is the collection cover (deleted photoId === collection.coverPhotoId):
         - Find the next photo in the grid (usually the one after the deleted photo, or the first if deleted was last)
         - Call PATCH /collections/:id/cover with the next photo's ID to promote it
         - Update collection state to reflect the new cover
       - If the deleted photo is NOT the cover, no action needed (cover remains unchanged)
    5. Test the deletion flow to ensure:
       - Deleting a non-cover photo does not change the cover
       - Deleting the cover photo triggers auto-promotion to the next photo
       - The cover badge moves to the new cover photo immediately

    Locked decision: Auto-promotion of cover on deletion per user decision from CONTEXT.md.
  </action>
  <verify>
    - Hover over a non-cover photo: set-cover button appears
    - Click set-cover on a different photo: cover badge moves immediately
    - Query or inspect reveals collection.coverPhotoId is updated
    - Delete a non-cover photo: cover badge remains on original cover photo
    - Delete the cover photo: cover badge immediately appears on the next photo
    - If there are multiple photos and delete the cover, the promoted photo shows the badge without manual refresh
  </verify>
  <done>
    Set-cover button updates the collection cover immediately. Deleting the cover photo automatically promotes the next available photo as the new cover. All state updates are immediate (no manual page refresh required).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>End-to-end photo upload workflow with thumbnails, auto-cover, and lightbox navigation</what-built>
  <how-to-verify>
    1. Navigate to a collection detail page and ensure it loads without errors.
    2. Upload a JPEG image via drag-and-drop. Observe:
       - Image appears in the grid as a thumbnail (small file size)
       - Cover badge appears immediately on the uploaded photo (auto-set cover)
       - No page refresh required; state updates are instant
    3. Upload a PNG and a WebP image. Observe:
       - Both upload successfully
       - Thumbnails appear in grid
       - Original cover badge (from first upload) remains unchanged
    4. Click any photo in the grid to open the lightbox. Observe:
       - Full-resolution image displays
       - "X of Y" counter is correct
       - ArrowLeft/ArrowRight navigate between photos
       - Escape closes the lightbox
    5. Hover over a non-cover photo and click "Set as cover". Observe:
       - Cover badge immediately moves to the selected photo
       - API call succeeds (check network tab)
    6. Delete a non-cover photo. Observe:
       - Photo is removed from grid
       - Cover badge remains on original cover photo
    7. Delete the cover photo. Observe:
       - Photo is removed from grid
       - Cover badge automatically moves to the next photo in the grid
    8. Verify mobile responsiveness: resize browser to mobile width and repeat steps 2–7. Observe:
       - Thumbnails still load fast (< 2 MB per 10 photos)
       - Grid adapts to 2–3 columns on mobile (per Tailwind config)
       - Lightbox is readable and navigable on mobile
    9. Open browser DevTools Network tab and reload the page. Observe:
       - Grid images (thumbnails) are each < 100 KB
       - Total grid assets < 2 MB (versus full-res originals which would be > 10 MB)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass. Describe any issues if any step fails (e.g., "cover badge didn't appear after first upload", "thumbnail at wrong size", etc.)</resume-signal>
</task>

</tasks>

<verification>
1. Lightbox renders full-resolution images with working prev/next navigation and close control.
2. Keyboard shortcuts (ArrowLeft, ArrowRight, Escape) work correctly in lightbox.
3. Photo counter displays accurate current/total count.
4. Cover badge displays on the correct photo and updates immediately after set-cover.
5. Deleting the cover photo automatically promotes the next photo as the new cover.
6. Grid thumbnails load fast (< 100 KB each); lightbox images are full-resolution.
7. All functionality works end-to-end without manual page refreshes.
8. Mobile responsive: grid adapts to mobile width; lightbox is readable and navigable.
</verification>

<success_criteria>
- Photographer uploads photos and sees them appear in a responsive grid with fast-loading thumbnails.
- First photo is automatically set as the collection cover with a visible badge.
- Photographer can view any photo fullscreen with prev/next keyboard navigation.
- Photographer can manually override the cover by clicking "Set as cover" on any photo.
- If the cover photo is deleted, the next photo is automatically promoted as the new cover.
- Grid load time is significantly faster than before thumbnails (verified via network inspector).
- All Phase 1 success criteria from ROADMAP are met.
</success_criteria>

<output>
After completion, create `.planning/phases/01-photo-upload/01-03-SUMMARY.md`
</output>
