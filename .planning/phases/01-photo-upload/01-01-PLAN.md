---
phase: 01-photo-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - database_schema.sql
  - backend/utils.php
  - backend/collections/photos.php
  - backend/.htaccess
autonomous: true

must_haves:
  truths:
    - "Thumbnail generation via GD produces JPEG files at 400px width for JPEG/PNG/WebP uploads"
    - "Uploading the first photo to a collection automatically sets it as the collection cover"
    - "Subsequent uploads do not override the collection cover"
    - "GD WebP support is verified; fallback approach is documented if unsupported"
    - "PHP upload_max_filesize on Hostinger is set or verified to accept 20 MB files"
  artifacts:
    - path: "database_schema.sql"
      provides: "thumbnailPath column on Photo table"
      contains: "ALTER TABLE Photo ADD COLUMN thumbnailPath"
    - path: "backend/utils.php"
      provides: "GD-based thumbnail generation in handleFileUpload()"
      min_lines: 30
    - path: "backend/collections/photos.php"
      provides: "Auto-cover logic on first photo upload"
      pattern: "coverPhotoId.*NULL"
    - path: "backend/.htaccess"
      provides: "PHP upload limit configuration"
      contains: "upload_max_filesize"
  key_links:
    - from: "backend/utils.php"
      to: "database_schema.sql"
      via: "handleFileUpload() stores thumbnailPath in Photo insert"
      pattern: "thumbnailPath"
    - from: "backend/collections/photos.php"
      to: "Photo table"
      via: "Auto-cover logic queries Collection.coverPhotoId then updates it"
      pattern: "INSERT INTO Photo.*UPDATE.*Collection.*coverPhotoId"
---

<objective>
Implement backend thumbnail generation, auto-cover on first upload, and schema migration.

Purpose: Enable the frontend to load fast-loading thumbnails in the photo grid while maintaining full-resolution originals for lightbox. Automatically set the first photo as collection cover to streamline the photographer workflow.

Output: Schema migration (thumbnailPath column), updated upload handler with GD thumbnail generation, auto-cover logic in POST /collections/{id}/photos endpoint, verified Hostinger environment compatibility.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-photo-upload/01-RESEARCH.md
@.planning/phases/01-photo-upload/01-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add thumbnailPath column to Photo table and verify GD support on Hostinger</name>
  <files>database_schema.sql, backend/.htaccess</files>
  <action>
    1. Open database_schema.sql and locate the Photo table definition.
    2. Add a new nullable column after storagePath: `thumbnailPath VARCHAR(191) NULL DEFAULT NULL`
    3. Commit the schema change locally (do NOT run the migration yet — it will execute when the backend runs the first time; OR test locally if you have a dev database).
    4. Update backend/.htaccess to set PHP upload limits matching the 20MB frontend limit. Add these lines at the top (after any existing directives):
       ```
       php_value upload_max_filesize 25M
       php_value post_max_size 30M
       ```
    5. Create a temporary test endpoint at backend/gd-test.php that calls gd_info() and returns JSON with WebP support status. This will be used for verification but can be deleted after confirmation.
    6. Test locally (if possible) or prepare instructions for running: `curl https://api.pixelforge.pro/backend/gd-test.php` to confirm GD WebP support.

    Locked decision: 400px thumbnail width per user decision. Decision pending on WebP fallback: if gd_info()['WebP Support'] is false, the implementation will fall back to JPEG conversion (convert WebP source to JPEG thumbnail).
  </action>
  <verify>
    - database_schema.sql contains new line: `thumbnailPath VARCHAR(191) NULL`
    - backend/.htaccess contains php_value directives for upload_max_filesize and post_max_size
    - backend/gd-test.php returns JSON with WebP support status (after execution, can be deleted)
    - GD is confirmed enabled via gd_info() output
  </verify>
  <done>
    Schema migration file ready to deploy; .htaccess configured for 20MB uploads; GD WebP support status known and documented (e.g., "WebP Support: true" or "WebP Support: false — fall back to JPEG").
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement GD-based thumbnail generation in handleFileUpload() utility</name>
  <files>backend/utils.php</files>
  <action>
    1. Open backend/utils.php and locate the handleFileUpload() function.
    2. After the move_uploaded_file() call (which moves the file to the uploads directory), add thumbnail generation logic:
       - Get the file's MIME type (already validated as image/jpeg, image/png, or image/webp)
       - Load the image using the appropriate GD function: imagecreatefromjpeg(), imagecreatefrompng(), or imagecreatefromwebp()
       - If imagecreatefromwebp() does not exist (WebP not supported), convert the source to a temporary JPEG first, then load that
       - Use imagescale() or imagecopyresampled() to resize the image to max 400px width while maintaining aspect ratio
       - Save the resized thumbnail as JPEG to backend/uploads/{collectionId}/thumbs/{photoId}_thumb.jpg
       - Create the thumbs/ subdirectory if it doesn't exist (mkdir with 0755 permissions)
    3. Modify handleFileUpload() to return an associative array with both storagePath and thumbnailPath:
       ```php
       return [
           'id' => $photoId,
           'filename' => $clientFilename,
           'storagePath' => $storagePath,
           'thumbnailPath' => $thumbnailPath ?? null,
           'createdAt' => $createdAt,
       ];
       ```
    4. Add error handling: if thumbnail generation fails (e.g., memory limit, GD error), log the error and set thumbnailPath to null. Do NOT reject the upload — let the photographer continue (user decision from CONTEXT.md).
    5. For very large source images (width × height > 25,000,000 pixels), skip thumbnail generation and set thumbnailPath to null to prevent memory exhaustion.

    Locked decision: 400px width for thumbnails. Claude's discretion on format: use JPEG as the universal output format (compatible with all source types, smallest file size).
  </action>
  <verify>
    - function handleFileUpload() returns array with thumbnailPath key
    - A test JPEG upload results in a file at backend/uploads/{collectionId}/thumbs/{id}_thumb.jpg
    - Thumbnail file is < 100 KB
    - Thumbnail aspect ratio matches original image aspect ratio
    - A test PNG upload generates a JPEG thumbnail
    - A test WebP upload either generates a JPEG thumbnail (if WebP supported) or sets thumbnailPath to null gracefully (if not supported)
    - Very large images (e.g., 8000×8000) do not crash PHP; thumbnailPath is set to null and upload succeeds
  </verify>
  <done>
    handleFileUpload() generates JPEG thumbnails at 400px width for all supported source formats. Failures degrade gracefully: if thumbnail generation fails, the original file is kept and thumbnailPath is null. Function returns both storagePath and thumbnailPath in response object.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add auto-cover logic and update Photo POST endpoint to return thumbnailPath</name>
  <files>backend/collections/photos.php</files>
  <action>
    1. Open backend/collections/photos.php and locate the POST handler (the section that handles file uploads via handleFileUpload()).
    2. After the INSERT INTO Photo completes (after the photo row is inserted), add auto-cover logic:
       - Query: `SELECT coverPhotoId FROM Collection WHERE id = ?` for the current collectionId
       - If coverPhotoId IS NULL, execute: `UPDATE Collection SET coverPhotoId = ?, updatedAt = ? WHERE id = ?` with the new photo's ID
       - Wrap this in a transaction or immediate follow-up so it's atomic
    3. Modify the POST response to include the thumbnailPath from handleFileUpload():
       ```php
       $response = [
           'status' => 'OK',
           'photo' => [
               'id' => $photoResult['id'],
               'filename' => $photoResult['filename'],
               'storagePath' => $photoResult['storagePath'],
               'thumbnailPath' => $photoResult['thumbnailPath'],
               'createdAt' => $photoResult['createdAt'],
           ],
       ];
       ```
    4. If auto-cover was set in this upload, include a flag in the response so the frontend knows to update its collection state:
       ```php
       if ($wasAutoCoverSet) {
           $response['autoSetCover'] = [
               'photoId' => $newPhotoId,
               'coverPhotoId' => $newPhotoId,
           ];
       }
       ```
    5. Return the response as JSON.

    Locked decision: Auto-cover only on first upload (when coverPhotoId is NULL). Subsequent uploads do not change the cover.
  </action>
  <verify>
    - curl -X POST /collections/{collectionId}/photos with a file upload returns JSON with photo.thumbnailPath populated
    - First photo upload to a collection with NULL coverPhotoId: response includes "autoSetCover" flag
    - Second photo upload to the same collection: response does NOT include "autoSetCover" flag
    - Query the Collection row after first photo upload: coverPhotoId equals the new photo's ID
    - Query the Collection row after second photo upload: coverPhotoId is unchanged (still the first photo)
    - Schema migration (thumbnailPath column) runs without errors
  </verify>
  <done>
    Photo POST endpoint returns thumbnailPath for each photo. Auto-cover logic is implemented: first photo sets coverPhotoId, subsequent uploads do not override it. Response includes autoSetCover flag when cover is auto-set, allowing frontend to update collection state immediately.
  </done>
</task>

</tasks>

<verification>
1. Schema migration: ALTER TABLE Photo ADD COLUMN thumbnailPath VARCHAR(191) NULL is present in database_schema.sql and can be deployed.
2. GD support: gd_info() confirms GD is enabled. WebP support status is documented (true or false + fallback approach if false).
3. PHP upload limits: backend/.htaccess sets upload_max_filesize to 25M and post_max_size to 30M.
4. Thumbnail generation: Upload a JPEG/PNG/WebP test photo and confirm thumbnail file exists at backend/uploads/{collectionId}/thumbs/{id}_thumb.jpg.
5. Auto-cover: Upload a photo to a collection with NULL coverPhotoId; query confirms coverPhotoId is set to the new photo's ID.
6. POST response: /collections/{id}/photos returns thumbnailPath and autoSetCover flag when applicable.
</verification>

<success_criteria>
- Photo table has thumbnailPath column that can be populated during uploads.
- GD-based thumbnail generation runs on every image upload, producing JPEG thumbnails at 400px width.
- Thumbnail generation failures do not block uploads (graceful degradation).
- First photo uploaded to a collection automatically sets the collection's coverPhotoId.
- Subsequent uploads do not override the cover.
- POST /collections/{id}/photos response includes thumbnailPath and autoSetCover flag (when set).
- PHP server is configured to accept 20MB uploads via upload_max_filesize and post_max_size.
</success_criteria>

<output>
After completion, create `.planning/phases/01-photo-upload/01-01-SUMMARY.md`
</output>
