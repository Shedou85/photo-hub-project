---
phase: 01-photo-upload
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/pages/CollectionDetailsPage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: true

must_haves:
  truths:
    - "Photo grid displays thumbnail images from thumbnailPath (not full-resolution originals)"
    - "Thumbnails load with significantly smaller file size than originals"
    - "Lightbox opens with full-resolution originals via storagePath"
    - "Collection cover badge appears immediately after the first photo upload without manual page refresh"
    - "Collection cover badge correctly shows which photo is the cover after auto-set on first upload"
  artifacts:
    - path: "frontend/src/pages/CollectionDetailsPage.jsx"
      provides: "Grid rendering with thumbnailPath, lightbox with storagePath, collection state update on auto-cover"
      min_lines: 50
    - path: "frontend/src/locales/en.json"
      provides: "i18n keys for cover auto-set (if any new UI prompts needed)"
      contains: "cover"
    - path: "frontend/src/locales/lt.json"
      provides: "Lithuanian translations"
    - path: "frontend/src/locales/ru.json"
      provides: "Russian translations"
  key_links:
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "backend/collections/photos.php"
      via: "POST response includes autoSetCover flag; frontend parses and updates collection state"
      pattern: "autoSetCover.*setCollection"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "photo grid rendering"
      via: "Grid <img> src uses photo.thumbnailPath ?? photo.storagePath"
      pattern: "photo\\.thumbnailPath.*storagePath"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "lightbox component"
      via: "Lightbox renders full-resolution from photo.storagePath"
      pattern: "lightbox.*storagePath"
---

<objective>
Update the frontend to consume thumbnails from the backend, properly reflect auto-cover state, and load the lightbox with full-resolution images.

Purpose: Ensure the photo grid loads fast with thumbnails while maintaining high-quality fullscreen viewing. Display the collection cover badge immediately after the first upload to provide immediate feedback to the photographer.

Output: Updated CollectionDetailsPage with thumbnail-aware grid, collection state management for auto-cover, and lightbox with full-resolution images. Locale files updated with any new i18n keys.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-photo-upload/01-RESEARCH.md
@.planning/phases/01-photo-upload/01-CONTEXT.md
@.planning/phases/01-photo-upload/01-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update photo grid to display thumbnails and add collection state update on auto-cover</name>
  <files>frontend/src/pages/CollectionDetailsPage.jsx</files>
  <action>
    1. Open frontend/src/pages/CollectionDetailsPage.jsx and locate the photo grid rendering section (the map over `photos` that renders each photo card).
    2. Update the `<img src>` to use thumbnailPath as the primary source, with storagePath as fallback:
       ```jsx
       <img
         src={photoUrl(photo.thumbnailPath ?? photo.storagePath)}
         alt={photo.filename}
         className="w-full h-full object-cover"
       />
       ```
    3. Locate the `uploadPhotos()` function or the upload completion handler (where `fetchPhotos()` is called).
    4. After the upload completes and `fetchPhotos()` is called, parse the responses from the POST /collections/{id}/photos endpoint.
    5. For each photo that was uploaded, check if the response includes `autoSetCover` flag. If true:
       - Update the `collection` state to set `coverPhotoId` to the new photo's ID
       - This will immediately trigger the cover badge to appear without needing a separate `fetchCollection()` call
    6. Update the logic:
       ```jsx
       const uploadedPhotos = response.map(r => r.photo);
       const newCoverId = uploadedPhotos.find(p => response.find(r => r.photo.id === p.id && r.autoSetCover))?.id;
       if (newCoverId) {
         setCollection(prev => ({ ...prev, coverPhotoId: newCoverId }));
       }
       ```
    7. Ensure the lightbox continues to use `photo.storagePath` (the full-resolution image) for fullscreen display. No changes to lightbox image source needed.
    8. Verify that the cover badge (`<div className="badge">`) still renders correctly based on `collection.coverPhotoId`.

    Locked decision: Use thumbnailPath as primary source, fall back to storagePath if missing. Lightbox continues with storagePath for full resolution.
  </action>
  <verify>
    - Grid `<img>` elements have src={photoUrl(photo.thumbnailPath ?? photo.storagePath)}
    - Upload a first photo to a collection: response includes autoSetCover flag
    - After upload, collection state is updated with new coverPhotoId without page refresh
    - Cover badge appears immediately on the newly uploaded photo
    - Lightbox opens and displays full-resolution image from storagePath
    - Grid images load with smaller file size than originals (verify with network inspector: thumbnails < 100 KB, originals > 500 KB)
  </verify>
  <done>
    Photo grid displays thumbnail images via thumbnailPath. Collection state is updated immediately when auto-cover is set, so the cover badge appears without manual refresh. Lightbox continues to display full-resolution originals. All image sources are properly set and fallbacks in place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure i18n keys are present for cover photo UI and locale files are in sync</name>
  <files>frontend/src/locales/en.json, frontend/src/locales/lt.json, frontend/src/locales/ru.json</files>
  <action>
    1. Open frontend/src/locales/en.json and search for any keys related to "cover" (e.g., "collections.setCover", "photos.setCover", "badge.cover", etc.).
    2. Verify that all cover-related keys are present in all three locale files (en.json, lt.json, ru.json).
    3. If the research identified any new UI elements for auto-cover (e.g., a toast notification "Photo set as cover" or "First photo automatically set as collection cover"), add those keys to all three locale files:
       - Example: `"photos.autoCoverSet": "First photo set as collection cover"`
       - Add to en.json, then translate to lt.json and ru.json
    4. Do NOT add new keys unless they are explicitly rendered in CollectionDetailsPage.jsx. If no new UI elements are added in this task, the existing keys should be sufficient.
    5. Verify that all three locale files have matching keys (no missing translations).

    Note: The research file indicates all i18n keys are already present in all 3 locales. This task is primarily a verification pass to ensure no new keys were added in Task 1 that need translation.
  </action>
  <verify>
    - All three locale files (en.json, lt.json, ru.json) contain the same cover-related keys
    - No TypeScript/React errors about missing i18n keys when the component renders
    - Run `npm run lint` in frontend/ directory: no errors about i18n keys
  </verify>
  <done>
    All locale files are in sync. Cover-related UI strings are available in English, Lithuanian, and Russian. No missing translations.
  </done>
</task>

</tasks>

<verification>
1. Photo grid renders `<img src>` with photo.thumbnailPath ?? photo.storagePath.
2. Upload first photo to a collection: cover badge appears immediately without page refresh.
3. Network inspector shows grid images are < 100 KB (thumbnails), lightbox images are > 500 KB (originals).
4. Locale files en.json, lt.json, ru.json have matching keys.
5. No console errors about missing i18n keys or undefined properties.
</verification>

<success_criteria>
- Photo grid displays thumbnail images via thumbnailPath, improving page load time on mobile.
- Lightbox displays full-resolution images via storagePath for high-quality fullscreen viewing.
- First photo upload automatically updates collection state and displays cover badge immediately.
- All UI text is properly localized in en, lt, and ru.
- No errors or missing property access in CollectionDetailsPage.
</success_criteria>

<output>
After completion, create `.planning/phases/01-photo-upload/01-02-SUMMARY.md`
</output>
