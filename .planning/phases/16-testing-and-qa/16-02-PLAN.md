---
phase: 16-testing-and-qa
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/vite.config.js
  - frontend/lighthouserc.json
  - frontend/scripts/check-bundle-size.js
autonomous: true

must_haves:
  truths:
    - "Production build completes and bundle sizes are measured"
    - "CSS bundle size is under 50KB gzipped (QUALITY-01)"
    - "Bundle visualizer generates treemap HTML for analysis"
    - "Lighthouse CI configuration exists with performance budget assertions"
  artifacts:
    - path: "frontend/lighthouserc.json"
      provides: "Lighthouse CI configuration with performance budgets"
      contains: "categories:performance"
    - path: "frontend/scripts/check-bundle-size.js"
      provides: "Bundle size checking script that reports gzipped sizes"
      contains: "gzip"
  key_links:
    - from: "frontend/lighthouserc.json"
      to: "https://pixelforge.pro"
      via: "Lighthouse CI audits production URLs"
      pattern: "pixelforge.pro"
    - from: "frontend/scripts/check-bundle-size.js"
      to: "frontend/dist"
      via: "reads build output to measure sizes"
      pattern: "dist"
---

<objective>
Set up performance monitoring infrastructure: Lighthouse CI configuration, bundle size analysis with rollup-plugin-visualizer, and a bundle size checking script.

Purpose: Establish automated performance baselines for QUALITY-01 (bundle <50KB CSS gzipped), QUALITY-02 (Lighthouse >90), QUALITY-03 (LCP <2.5s), QUALITY-04 (CLS <0.1).
Output: Lighthouse CI config, bundle visualizer integration, bundle size script, verified production build metrics.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-testing-and-qa/16-RESEARCH.md

@frontend/vite.config.js
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rollup-plugin-visualizer and create bundle size checking script</name>
  <files>
    frontend/package.json
    frontend/vite.config.js
    frontend/scripts/check-bundle-size.js
  </files>
  <action>
Install bundle analysis dependency:
```bash
cd frontend && npm install -D rollup-plugin-visualizer
```

Update `frontend/vite.config.js`:
- Import `visualizer` from `rollup-plugin-visualizer`
- Add visualizer to Vite plugins array, configured with:
  - `filename: 'dist/stats.html'`
  - `gzipSize: true`
  - `brotliSize: true`
  - `open: false` (don't auto-open in browser during build)
- Keep existing proxy config and react plugin untouched

Create `frontend/scripts/check-bundle-size.js`:
- Node.js script that reads all files in `frontend/dist/assets/`
- For each `.css` file: report raw size and gzipped size (use `zlib.gzipSync`)
- For each `.js` file: report raw size and gzipped size
- Print a summary table: file name | raw KB | gzipped KB
- Check CSS gzipped total against 50KB limit (QUALITY-01)
- Exit with code 1 if CSS gzipped exceeds 50KB, exit 0 otherwise
- Use only Node.js built-in modules (fs, path, zlib) — no external deps

Add npm script: `"build:analyze": "vite build && node scripts/check-bundle-size.js"`
  </action>
  <verify>
Run `cd frontend && npm run build` — build completes successfully, `dist/stats.html` is generated.
Run `cd frontend && node scripts/check-bundle-size.js` — prints bundle sizes, exits 0 (CSS under 50KB gzipped).
  </verify>
  <done>Bundle visualizer generates treemap on build. Bundle size script reports gzipped sizes and enforces 50KB CSS budget.</done>
</task>

<task type="auto">
  <name>Task 2: Create Lighthouse CI configuration with performance budgets</name>
  <files>
    frontend/lighthouserc.json
  </files>
  <action>
Create `frontend/lighthouserc.json` with Lighthouse CI configuration:

```json
{
  "ci": {
    "collect": {
      "url": [
        "https://pixelforge.pro/",
        "https://pixelforge.pro/login"
      ],
      "numberOfRuns": 3,
      "settings": {
        "preset": "desktop"
      }
    },
    "assert": {
      "assertions": {
        "categories:performance": ["error", {"minScore": 0.9}],
        "largest-contentful-paint": ["error", {"maxNumericValue": 2500}],
        "cumulative-layout-shift": ["error", {"maxNumericValue": 0.1}],
        "total-blocking-time": ["warn", {"maxNumericValue": 300}],
        "first-contentful-paint": ["warn", {"maxNumericValue": 1800}],
        "speed-index": ["warn", {"maxNumericValue": 3400}]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

Notes:
- Only audit public pages (/, /login) since authenticated pages require login state
- 3 runs for statistical reliability
- Desktop preset matches primary photographer use case
- Assertions match phase requirements: performance >90 (QUALITY-02), LCP <2.5s (QUALITY-03), CLS <0.1 (QUALITY-04)
- Upload to temporary public storage for result viewing (free, no setup)

Add npm script to package.json: `"lighthouse": "lhci autorun --config=lighthouserc.json"`

Note: Do NOT install @lhci/cli as a local dep. It's 200MB+. Add a note in the script that it should be installed globally: `npm install -g @lhci/cli` when running lighthouse audits. The npm script assumes global install.
  </action>
  <verify>
Verify `frontend/lighthouserc.json` is valid JSON: `cd frontend && node -e "require('./lighthouserc.json')"`
  </verify>
  <done>Lighthouse CI configuration exists with performance budgets matching QUALITY-02 (>90), QUALITY-03 (LCP <2.5s), QUALITY-04 (CLS <0.1). Can be run with `lhci autorun` when needed.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` — completes, `dist/stats.html` generated
2. `cd frontend && node scripts/check-bundle-size.js` — exits 0, CSS gzipped < 50KB
3. `cd frontend && node -e "require('./lighthouserc.json')"` — valid JSON
4. `package.json` has `build:analyze` and `lighthouse` scripts
5. Zero ESLint warnings: `cd frontend && npm run lint`
</verification>

<success_criteria>
- Production build generates bundle visualizer at dist/stats.html
- Bundle size script reports CSS gzipped size and enforces <50KB limit
- Lighthouse CI config asserts: performance >90, LCP <2.5s, CLS <0.1
- All npm scripts work: build, build:analyze, lighthouse
</success_criteria>

<output>
After completion, create `.planning/phases/16-testing-and-qa/16-02-SUMMARY.md`
</output>
