---
phase: 09-photographer-dashboard-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/collections/share.php
  - frontend/src/pages/SharePage.jsx
  - frontend/src/pages/CollectionDetailsPage.jsx
  - frontend/src/pages/CollectionsListPage.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: true

must_haves:
  truths:
    - "Client accessing /share/{shareId} is automatically redirected to /deliver/{deliveryToken} when collection status is DELIVERED or DOWNLOADED"
    - "Photographer sees Copy Delivery Link button in CollectionDetailsPage when status is DELIVERED or DOWNLOADED"
    - "Clicking Copy Delivery Link copies correct URL to clipboard and shows toast confirmation"
    - "Collection cards in CollectionsListPage show DOWNLOADED status with purple-200 badge"
    - "CollectionDetailsPage header badge shows DOWNLOADED status with purple-200 styling"
  artifacts:
    - path: "backend/collections/share.php"
      provides: "deliveryToken in share response when status is DELIVERED/DOWNLOADED"
      contains: "deliveryToken"
    - path: "frontend/src/pages/SharePage.jsx"
      provides: "Redirect logic from share page to delivery page"
      contains: "window.location.href.*deliver"
    - path: "frontend/src/pages/CollectionDetailsPage.jsx"
      provides: "Copy Delivery Link button and DOWNLOADED badge styling"
      contains: "handleCopyDeliveryLink"
    - path: "frontend/src/pages/CollectionsListPage.jsx"
      provides: "DOWNLOADED badge styling in collection cards"
      contains: "DOWNLOADED"
  key_links:
    - from: "backend/collections/share.php"
      to: "frontend/src/pages/SharePage.jsx"
      via: "deliveryToken field in share response enables redirect"
      pattern: "deliveryToken"
    - from: "frontend/src/pages/CollectionDetailsPage.jsx"
      to: "navigator.clipboard"
      via: "handleCopyDeliveryLink copies delivery URL"
      pattern: "navigator\\.clipboard\\.writeText"
---

<objective>
Integrate delivery management into the photographer's dashboard and complete the share-to-delivery redirect flow.

Purpose: Photographer needs to copy delivery links for clients and see download confirmation. Clients accessing the old selection link after delivery should be automatically forwarded to the delivery page.

Output: Updated SharePage with redirect logic, CollectionDetailsPage with delivery link copy button, and DOWNLOADED badge styling in both CollectionDetailsPage and CollectionsListPage. Small backend change to include deliveryToken in share endpoint response.
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@backend/collections/share.php
@frontend/src/pages/SharePage.jsx
@frontend/src/pages/CollectionDetailsPage.jsx
@frontend/src/pages/CollectionsListPage.jsx
@frontend/src/locales/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SharePage redirect and backend deliveryToken exposure</name>
  <files>
    backend/collections/share.php
    frontend/src/pages/SharePage.jsx
  </files>
  <action>
**Backend (share.php):**

The GET handler (line 91) queries `SELECT id, name, status, clientName, shareId, coverPhotoId, createdAt` — it does NOT include `deliveryToken`. Add `deliveryToken` to the SELECT query. This is safe because the share endpoint is accessed by clients who already have the shareId, and deliveryToken is only useful when status is DELIVERED/DOWNLOADED (the token is null otherwise).

Update the SELECT on line 92 to:
```sql
SELECT id, name, status, clientName, shareId, coverPhotoId, deliveryToken, createdAt
FROM `Collection`
WHERE shareId = ?
LIMIT 1
```

**Frontend (SharePage.jsx):**

In the `fetchCollection` useEffect (around line 116-153), after `const data = await response.json()` and the `data.status === 'OK'` check, add a redirect check BEFORE `setCollection(coll)`:

```jsx
const coll = data.collection;

// Redirect to delivery page if collection is in delivery phase
if ((coll.status === 'DELIVERED' || coll.status === 'DOWNLOADED') && coll.deliveryToken) {
  window.location.href = `/deliver/${coll.deliveryToken}`;
  return;
}

setCollection(coll);
```

Use `window.location.href` (not React Router navigate) because the delivery page is a public page with its own context — no React state needs preserving. The `return` after redirect prevents further SharePage rendering.

Key: Check BOTH status AND deliveryToken existence. If status is DELIVERED but deliveryToken is null (edge case), fall through to show SharePage normally rather than redirect to a broken URL.
  </action>
  <verify>
1. Read share.php and confirm SELECT query includes deliveryToken
2. Read SharePage.jsx and confirm redirect logic exists before setCollection
3. `cd frontend && npx eslint src/pages/SharePage.jsx --no-warn-ignored` — no errors
  </verify>
  <done>
Share endpoint returns deliveryToken in response. SharePage redirects to `/deliver/{deliveryToken}` when collection status is DELIVERED or DOWNLOADED and deliveryToken exists. No redirect occurs for SELECTING/REVIEWING status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add delivery link copy button and DOWNLOADED badge styling</name>
  <files>
    frontend/src/pages/CollectionDetailsPage.jsx
    frontend/src/pages/CollectionsListPage.jsx
    frontend/src/locales/en.json
    frontend/src/locales/lt.json
    frontend/src/locales/ru.json
  </files>
  <action>
**CollectionDetailsPage.jsx — Copy Delivery Link button:**

1. Add `handleCopyDeliveryLink` function after existing `handleCopyShareLink` (around line 459):

```jsx
const handleCopyDeliveryLink = () => {
  if (!collection.deliveryToken) {
    toast.error(t('collection.deliveryTokenMissing'));
    return;
  }
  const url = `${window.location.origin}/deliver/${collection.deliveryToken}`;
  navigator.clipboard.writeText(url).then(() => {
    toast.success(t('collection.deliveryLinkCopied'));
  }).catch(() => {
    toast.error(t('collection.linkCopyFailed'));
  });
};
```

2. Add the button in the action buttons `div.flex.gap-3` section (around line 625-659), after the "Mark as Delivered" button block. Add this conditional block:

```jsx
{(collection.status === 'DELIVERED' || collection.status === 'DOWNLOADED') && collection.deliveryToken && (
  <button
    onClick={handleCopyDeliveryLink}
    className="inline-flex items-center gap-2 py-[9px] px-[22px] text-[14px] font-semibold text-white bg-[linear-gradient(135deg,#10b981,#059669)] border-none rounded-[6px] cursor-pointer font-sans transition-opacity duration-150 hover:opacity-[0.88]"
  >
    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    {t('collection.copyDeliveryLink')}
  </button>
)}
```

Green gradient (`#10b981` to `#059669`) — visually distinct from blue share link button. Download icon consistent with delivery semantics. Conditionally rendered only when status is DELIVERED/DOWNLOADED AND deliveryToken exists (double protection).

**CollectionDetailsPage.jsx — DOWNLOADED badge in header:**

3. Update the status badge ternary (around line 598-602) to add DOWNLOADED case:

Change from:
```
collection.status === 'DELIVERED' ? 'bg-purple-100 text-purple-700' :
'bg-gray-100 text-gray-600'
```

To:
```
collection.status === 'DELIVERED' ? 'bg-purple-100 text-purple-700' :
collection.status === 'DOWNLOADED' ? 'bg-purple-200 text-purple-800' :
'bg-gray-100 text-gray-600'
```

**CollectionsListPage.jsx — DOWNLOADED badge in cards:**

4. Update the status badge ternary (around line 257-261) to add DOWNLOADED case:

Change from:
```
collection.status === 'DELIVERED' ? 'bg-purple-100 text-purple-700' :
'bg-gray-100 text-gray-600'
```

To:
```
collection.status === 'DELIVERED' ? 'bg-purple-100 text-purple-700' :
collection.status === 'DOWNLOADED' ? 'bg-purple-200 text-purple-800' :
'bg-gray-100 text-gray-600'
```

Purple-200/purple-800 keeps DOWNLOADED in the same color family as DELIVERED (purple-100/purple-700) while being visually distinct. This groups both as "delivery phase" statuses.

**i18n — Add delivery-related keys to all three locale files:**

5. Add to `collection` namespace in `en.json`:
```json
"copyDeliveryLink": "Copy delivery link",
"deliveryLinkCopied": "Delivery link copied!",
"deliveryTokenMissing": "Delivery link not available yet.",
"linkCopyFailed": "Failed to copy link. Please try again."
```

6. Add to `collection` namespace in `lt.json`:
```json
"copyDeliveryLink": "Kopijuoti pristatymo nuorodą",
"deliveryLinkCopied": "Pristatymo nuoroda nukopijuota!",
"deliveryTokenMissing": "Pristatymo nuoroda dar neparuošta.",
"linkCopyFailed": "Nepavyko nukopijuoti nuorodos. Bandykite dar kartą."
```

7. Add to `collection` namespace in `ru.json`:
```json
"copyDeliveryLink": "Скопировать ссылку доставки",
"deliveryLinkCopied": "Ссылка доставки скопирована!",
"deliveryTokenMissing": "Ссылка доставки еще не готова.",
"linkCopyFailed": "Не удалось скопировать ссылку. Попробуйте еще раз."
```

Place new keys after existing `markedAsDelivered` key in the `collection` namespace.
  </action>
  <verify>
1. Read CollectionDetailsPage.jsx and confirm:
   - `handleCopyDeliveryLink` function exists
   - Button renders conditionally for DELIVERED/DOWNLOADED
   - DOWNLOADED badge has purple-200 styling
2. Read CollectionsListPage.jsx and confirm DOWNLOADED badge has purple-200 styling
3. Read all three locale files and confirm new keys exist in all
4. `cd frontend && npx eslint src/pages/CollectionDetailsPage.jsx src/pages/CollectionsListPage.jsx --no-warn-ignored` — no errors
5. `cd frontend && npm run build` — builds without errors
  </verify>
  <done>
CollectionDetailsPage shows green "Copy Delivery Link" button when status is DELIVERED/DOWNLOADED. Both CollectionDetailsPage and CollectionsListPage show purple-200 DOWNLOADED badge. All i18n keys added to en/lt/ru locale files. Build passes.
  </done>
</task>

</tasks>

<verification>
1. **SharePage redirect:** Access `/share/{shareId}` for a DELIVERED collection — should redirect to `/deliver/{deliveryToken}`. Access for a SELECTING collection — should show SharePage normally (no redirect).
2. **Copy Delivery Link:** Open CollectionDetailsPage for a DELIVERED collection — green "Copy Delivery Link" button visible. Click it — toast shows "Delivery link copied!" and clipboard contains `{origin}/deliver/{deliveryToken}`.
3. **Button visibility:** Open CollectionDetailsPage for a REVIEWING collection — no "Copy Delivery Link" button visible. Only "Copy Share Link" and "Mark as Delivered" buttons.
4. **DOWNLOADED badge:** Collection card in CollectionsListPage shows purple-200 badge for DOWNLOADED status. CollectionDetailsPage header also shows purple-200 badge.
5. **i18n:** Switch language to LT or RU — all new strings render correctly in respective language.
6. **Build:** `npm run build` completes without errors.
</verification>

<success_criteria>
- SharePage redirects to delivery page for DELIVERED/DOWNLOADED collections
- "Copy Delivery Link" button appears only for DELIVERED/DOWNLOADED status with deliveryToken
- DOWNLOADED badge renders with purple-200/purple-800 styling in both list and details pages
- All three locale files have matching delivery-related keys
- Frontend build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-photographer-dashboard-integration/09-01-SUMMARY.md`
</output>
