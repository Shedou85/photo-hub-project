---
phase: 08-client-delivery-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/index.php
  - backend/collections/deliver-view.php
  - frontend/src/pages/DeliveryPage.jsx
  - frontend/src/App.jsx
  - frontend/src/locales/en.json
  - frontend/src/locales/lt.json
  - frontend/src/locales/ru.json
autonomous: true

must_haves:
  truths:
    - "Client can access delivery page at /deliver/{deliveryToken} without logging in"
    - "Delivery page displays only edited/final photos (EditedPhoto table), never proof photos"
    - "Delivery page shows 'Download All as ZIP' button that triggers ZIP download"
    - "Delivery page shows individual download buttons on grid hover and in lightbox"
    - "Invalid delivery token shows 404 error page"
    - "Non-DELIVERED/DOWNLOADED collection shows 403 'not ready' error page"
  artifacts:
    - path: "backend/collections/deliver-view.php"
      provides: "Public delivery gallery data endpoint"
      contains: "EditedPhoto"
    - path: "frontend/src/pages/DeliveryPage.jsx"
      provides: "Client-facing delivery page with photo grid, lightbox, and download buttons"
      min_lines: 100
  key_links:
    - from: "frontend/src/App.jsx"
      to: "frontend/src/pages/DeliveryPage.jsx"
      via: "Route path=/deliver/:deliveryToken"
      pattern: "deliver.*deliveryToken"
    - from: "backend/index.php"
      to: "backend/collections/deliver-view.php"
      via: "require_once deliver-view.php when subRoute is empty"
      pattern: "deliver-view\\.php"
    - from: "frontend/src/pages/DeliveryPage.jsx"
      to: "frontend/src/utils/download.js"
      via: "import downloadPhoto, downloadAllAsZip"
      pattern: "import.*download"
    - from: "backend/collections/deliver-view.php"
      to: "EditedPhoto table"
      via: "PDO SELECT query"
      pattern: "FROM EditedPhoto"
---

<objective>
Build the complete client delivery interface: a public page where clients access their edited photos via delivery token URL, view them in a gallery with lightbox, and download individually or as ZIP.

Purpose: This is the final user-facing piece of the delivery workflow. Clients receive a single link and can immediately browse and download their photos without creating an account.

Output: Working delivery page at `/deliver/{token}` with backend data endpoint, photo grid, lightbox, download buttons (ZIP + individual), error states, and i18n support (LT/EN/RU).
</objective>

<execution_context>
@C:/Users/Marius/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Marius/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-client-delivery-interface/08-RESEARCH.md

Key existing files to reference:
@frontend/src/pages/SharePage.jsx — Reuse grid+lightbox pattern (simplified for downloads)
@frontend/src/utils/download.js — Import downloadPhoto and downloadAllAsZip
@backend/index.php — Add deliver-view.php route in /deliver/ handler
@backend/collections/share.php — Reference pattern for public token-based endpoint
@frontend/src/locales/en.json — Add "delivery" namespace
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend delivery view endpoint and route wiring</name>
  <files>
    backend/collections/deliver-view.php
    backend/index.php
  </files>
  <action>
    **Create `backend/collections/deliver-view.php`:**

    Public endpoint returning collection metadata + EditedPhoto array for a valid delivery token. No authentication required (delivery token IS the credential).

    Implementation:
    1. Require `db.php`. Extract delivery token from URI parts (`$uriParts[1]`).
    2. Validate delivery token is not empty (400 if missing).
    3. Only accept GET requests (405 for others).
    4. Query `Collection` table: `SELECT id, name, clientName, status, createdAt FROM Collection WHERE deliveryToken = ? LIMIT 1`.
    5. Return 404 if no collection found.
    6. Validate status is DELIVERED or DOWNLOADED. Return 403 with `{'error': 'Collection not ready for delivery', 'status': ...}` for any other status (DRAFT, SELECTING, REVIEWING, ARCHIVED).
    7. Query `EditedPhoto` table (NOT Photo table): `SELECT id, filename, storagePath, createdAt FROM EditedPhoto WHERE collectionId = ? ORDER BY filename ASC`.
    8. Return JSON: `{'status': 'OK', 'collection': {id, name, clientName, collectionStatus, createdAt, photoCount, photos: [...]}}`
    9. Wrap in try/catch, return 500 on exceptions.

    **Update `backend/index.php`:**

    In the existing `/deliver/` route handler (lines 200-228), add a case for empty `$subRoute` BEFORE the existing switch statement. When `$subRoute` is empty (meaning the URL is `/deliver/{token}` with no sub-path like /zip or /photo), require `deliver-view.php` for GET requests, return 405 for others, then break.

    The modified flow:
    ```
    if empty($subRoute) → require deliver-view.php (gallery data)
    switch ($subRoute):
      case 'zip' → zip-download.php (existing)
      case 'photo' → photo-download.php (existing)
      default → 404
    ```

    IMPORTANT: The empty subRoute check MUST come before the switch to avoid falling into the default 404 case.
  </action>
  <verify>
    Verify file exists and contains correct patterns:
    - `grep "EditedPhoto" backend/collections/deliver-view.php` returns matches (querying EditedPhoto, not Photo)
    - `grep "deliver-view.php" backend/index.php` returns match (route wired)
    - `grep "DELIVERED.*DOWNLOADED" backend/collections/deliver-view.php` returns match (status validation)
    - `npm run lint` passes from frontend/ directory (no frontend changes in this task)
  </verify>
  <done>
    - GET /deliver/{validToken} returns 200 with collection metadata and EditedPhoto array
    - GET /deliver/{invalidToken} returns 404 with error JSON
    - GET /deliver/{tokenForDraftCollection} returns 403 with status
    - Existing /deliver/{token}/zip and /deliver/{token}/photo/{id} endpoints still work (no regression)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DeliveryPage component with gallery, lightbox, downloads, and i18n</name>
  <files>
    frontend/src/pages/DeliveryPage.jsx
    frontend/src/App.jsx
    frontend/src/locales/en.json
    frontend/src/locales/lt.json
    frontend/src/locales/ru.json
  </files>
  <action>
    **Create `frontend/src/pages/DeliveryPage.jsx`:**

    Build a public delivery page modeled on SharePage.jsx structure but simplified for download-only workflow (no selection UI). Use the complete component from the research document (Pattern 2 in 08-RESEARCH.md) as the implementation reference.

    Key elements:
    1. Extract `deliveryToken` from URL params via `useParams()`.
    2. State: `collection` (null), `loading` (true), `error` (null), `lightboxIndex` (null).
    3. Keyboard navigation useEffect for lightbox (Escape, ArrowLeft, ArrowRight) — same pattern as SharePage.
    4. Fetch useEffect: `GET ${VITE_API_BASE_URL}/deliver/${deliveryToken}`. Handle 404 → error='notFound', 403 → error='notReady', network errors → error='error'. Always clear loading in `finally`.
    5. `photoUrl()` helper: construct full image URL from `storagePath` using `VITE_API_BASE_URL`.
    6. Loading state: centered text with `t('delivery.loading')`.
    7. Error state: centered message with appropriate error text from i18n. Use a package icon (emoji or SVG).
    8. Gallery layout:
       - Header: collection name (h1), client name (subtitle), photo count, prominent "Download All as ZIP" button with blue/indigo gradient (`bg-[linear-gradient(135deg,#3b82f6_0%,#6366f1_100%)]`).
       - Photo grid: `grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2`. Each photo has aspect-square container with hover overlay showing download icon. Click opens lightbox, hover download button calls `downloadPhoto(deliveryToken, photo.id, photo.filename)` with `e.stopPropagation()`.
       - Empty state: centered message when no photos.
       - Footer: "Powered by PixelForge" with border-t.
    9. Lightbox: Full-screen overlay with prev/next arrows, close button, counter. Download button in top-left corner calling `downloadPhoto()`. Same keyboard nav as SharePage.
    10. Prevent right-click and drag on all images: `onContextMenu={e => e.preventDefault()}` and `draggable={false}`.
    11. ALL user-visible strings use `t('delivery.key')` — zero hardcoded strings.
    12. Import `downloadPhoto` and `downloadAllAsZip` from `'../utils/download'`.
    13. Use Tailwind classes exclusively. No inline styles except unavoidable dynamic values.

    **Update `frontend/src/App.jsx`:**

    1. Add import: `import DeliveryPage from './pages/DeliveryPage';`
    2. Add public route after the SharePage route: `<Route path="/deliver/:deliveryToken" element={<DeliveryPage />} />`
    3. No ProtectedRoute wrapper (this is a public page).

    **Update locale files — add `"delivery"` namespace to all 3 files:**

    Keys to add (same structure in all 3 locales):
    - `loading` — Loading gallery message
    - `notFound` — Invalid/expired token error
    - `notReady` — Collection not delivered yet error
    - `error` — Generic error message
    - `photosCount` — Photo count with plurals (use `_one`/`_other` suffixes; Lithuanian also needs `_few`/`_many`)
    - `downloadAllAsZip` — ZIP download button text
    - `downloadPhoto` — Individual download button text/aria-label
    - `noPhotos` — Empty gallery state
    - `poweredBy` — Footer branding
    - `lightboxClose`, `lightboxPrev`, `lightboxNext` — Lightbox controls

    Use the translations from 08-RESEARCH.md Pattern 5. For Lithuanian plurals, follow existing patterns in lt.json (e.g., `photosCount_one`, `photosCount_few`, `photosCount_many`, `photosCount_other`). For Russian plurals, follow existing patterns in ru.json (e.g., `photosCount_one`, `photosCount_few`, `photosCount_many`, `photosCount_other`).
  </action>
  <verify>
    - `npm run lint` passes from `frontend/` directory
    - `npm run build` succeeds from `frontend/` directory
    - `grep "DeliveryPage" frontend/src/App.jsx` shows import and route
    - `grep "delivery" frontend/src/locales/en.json` shows delivery namespace keys
    - `grep "delivery" frontend/src/locales/lt.json` shows delivery namespace keys
    - `grep "delivery" frontend/src/locales/ru.json` shows delivery namespace keys
    - `grep "downloadPhoto\|downloadAllAsZip" frontend/src/pages/DeliveryPage.jsx` shows download utility imports
    - `grep "EditedPhoto\|Photo" frontend/src/pages/DeliveryPage.jsx` returns NO matches (frontend should not reference table names — it receives data from API)
  </verify>
  <done>
    - DeliveryPage renders at /deliver/:deliveryToken route (public, no auth required)
    - Page fetches and displays edited photos in responsive grid (2/3/4 columns)
    - "Download All as ZIP" button triggers ZIP download via downloadAllAsZip()
    - Grid hover shows download icon that triggers downloadPhoto() per photo
    - Lightbox opens on photo click with prev/next/close/download controls and keyboard navigation
    - Error states display correctly: 404 (invalid token), 403 (not ready), generic error
    - All strings internationalized in EN, LT, RU locale files
    - Build and lint pass
  </done>
</task>

</tasks>

<verification>
Phase 8 verification checklist:
1. Navigate to `/deliver/{validDeliveryToken}` — should show gallery with edited photos, ZIP download button, individual download overlays on hover
2. Navigate to `/deliver/invalid-token-123` — should show "not found" error state
3. Navigate to `/deliver/{tokenForReviewingCollection}` — should show "not ready" error state
4. Click "Download All as ZIP" — browser initiates ZIP download
5. Hover over grid photo — download overlay appears; click triggers individual download
6. Click grid photo — lightbox opens; prev/next/close/download all work
7. Press Escape in lightbox — closes; ArrowLeft/ArrowRight navigate
8. Switch language to LT/RU — all strings translate correctly
9. Existing /share/{shareId} page still works (no regression)
10. Existing /deliver/{token}/zip and /deliver/{token}/photo/{id} endpoints still work
</verification>

<success_criteria>
- `npm run build` passes
- `npm run lint` passes
- DeliveryPage.jsx exists and imports download utilities
- deliver-view.php queries EditedPhoto table (not Photo table)
- backend/index.php routes /deliver/{token} (no subRoute) to deliver-view.php
- All 3 locale files have "delivery" namespace with matching keys
- App.jsx has public /deliver/:deliveryToken route (no ProtectedRoute)
</success_criteria>

<output>
After completion, create `.planning/phases/08-client-delivery-interface/08-01-SUMMARY.md`
</output>
